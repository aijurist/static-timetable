<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Timetable Visualizer - 6 Day Schedule</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theory-color: #60a5fa;
            --theory-border: #3b82f6;
            --tutorial-color: #34d399;
            --tutorial-border: #10b981;
            --lab-same-color: #a78bfa;
            --lab-same-border: #8b5cf6;
            --lab-different-color: #fbbf24;
            --lab-different-border: #f59e0b;
            --lab-mixed-color: #f87171;
            --lab-mixed-border: #ef4444;
            --lecture-color: #fb7185;
            --lecture-border: #f43f5e;
            --header-bg: #1f2937;
            --cell-bg: #374151;
            --border-color: #4b5563;
            --hover-bg: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
        }

        /* Light theme overrides */
        body.light-theme {
            --header-bg: #ffffff;
            --cell-bg: #f9fafb;
            --border-color: #cbd5e1;
            --hover-bg: #e2e8f0;
            --text-primary: #1f2937;
            --text-secondary: #475569;
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
        }

        /* Additional light theme component tweaks */
        body.light-theme .container {
            background: var(--bg-secondary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body.light-theme .lesson-block {
            box-shadow: none;
            border-width: 1px;
        }

        body.light-theme .lesson-block:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .timetable {
            background-color: var(--border-color);
        }

        body.light-theme .cell {
            border-color: var(--border-color);
        }

        body.light-theme .legend {
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
        }

        body.light-theme .header {
            background-color: var(--header-bg);
            color: var(--text-primary);
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        /* Responsive design for 6-day layout */
        @media (max-width: 1200px) {
            .container {
                max-width: 95%;
                padding: 15px;
            }
            
            .timetable {
                font-size: 0.85em;
            }
            
            .lesson-block {
                padding: 6px;
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 900px) {
            .timetable {
                grid-template-columns: 100px repeat(6, 1fr);
                font-size: 0.8em;
            }
            
            .lesson-block {
                padding: 4px;
                font-size: 0.8em;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
            }
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-weight: 500;
            font-size: 2.2em;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-group label {
            color: var(--text-secondary);
            font-weight: 500;
            min-width: 80px;
        }

        select, .toggle-btn, input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--cell-bg);
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            min-width: 120px;
            transition: all 0.2s;
        }

        input[type="text"] {
            cursor: text;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--theory-color);
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }

        .toggle-btn {
            background-color: var(--cell-bg);
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background-color: var(--theory-color);
            color: var(--bg-primary);
            border-color: var(--theory-border);
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
        }

        .toggle-btn:hover {
            background-color: var(--hover-bg);
            border-color: var(--theory-border);
        }

        .toggle-btn.active:hover {
            background-color: var(--theory-border);
        }

        select:focus {
            outline: none;
            border-color: var(--theory-color);
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }

        .timetable {
            display: grid;
            grid-template-columns: 120px repeat(6, 1fr);
            gap: 1px;
            background-color: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .timetable[data-combined="true"] {
            overflow: visible; /* Allow spanning blocks in combined view */
            position: relative;
            z-index: 1;
        }

        /* Ensure timetable container doesn't clip spanning elements */
        #timetableContainer {
            overflow: visible;
            position: relative;
        }

        /* Combined lab block styling */
        .combined-lab-block {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .combined-lab-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .lab-time-header {
            font-weight: 700;
            font-size: 1em;
            text-align: center;
            margin-bottom: 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.98);
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .lab-course-title {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 4px;
            line-height: 1.3;
            color: rgba(255, 255, 255, 0.95);
        }

        .lab-teacher, .lab-room {
            font-size: 0.8em;
            opacity: 0.9;
            margin-bottom: 3px;
            color: rgba(255, 255, 255, 0.85);
        }

        .lab-batches {
            font-size: 0.75em; 
            opacity: 0.85;
            margin-top: 4px;
            font-style: italic;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: inline-block;
        }

        .lab-multiple-courses {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .lab-course-item {
            flex: 1;
            padding: 4px 0;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            padding-left: 8px;
        }

        .lab-course-name {
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 3px;
            line-height: 1.2;
            color: rgba(255, 255, 255, 0.95);
        }

        .lab-course-details {
            font-size: 0.75em;
            opacity: 0.8;
            line-height: 1.2;
            color: rgba(255, 255, 255, 0.8);
        }

        .lab-separator {
            text-align: center;
            font-weight: bold;
            opacity: 0.4;
            font-size: 1em;
            margin: 4px 0;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Visual indicator for lab span cells */
        .lab-span-cell {
            background: transparent !important; /* Remove pattern to avoid covering spanning block */
            pointer-events: none; /* Allow clicks to pass through to combined block */
            z-index: 0 !important; /* Ensure it stays below spanning block */
        }

        /* Ensure lab span cells don't hide spanning blocks */
        .lab-span-cell .combined-lab-block {
            position: absolute !important;
            z-index: 300 !important;
        }

        .header {
            background-color: var(--header-bg);
            padding: 12px;
            text-align: center;
            font-weight: 500;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .time-slot {
            background-color: var(--header-bg);
            padding: 8px;
            text-align: center;
            font-size: 0.85em;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .cell {
            background-color: var(--cell-bg);
            padding: 4px;
            min-height: 80px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: visible; /* Allow spanning blocks to extend beyond cell boundaries */
        }

        .cell:hover {
            background-color: var(--hover-bg);
        }

        .lesson-block {
            margin: 1px;
            padding: 6px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 0.8em;
            line-height: 1.2;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .lesson-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .theory {
            background-color: var(--theory-color);
            border: 1px solid var(--theory-border);
        }

        .lecture {
            background-color: var(--lecture-color);
            border: 1px solid var(--lecture-border);
        }

        .tutorial {
            background-color: var(--tutorial-color);
            border: 1px solid var(--tutorial-border);
        }

        .lab-same {
            background-color: var(--lab-same-color);
            border: 1px solid var(--lab-same-border);
        }

        .lab-different {
            background-color: var(--lab-different-color);
            border: 1px solid var(--lab-different-border);
        }

        .lab-mixed {
            background-color: var(--lab-mixed-color);
            border: 1px solid var(--lab-mixed-border);
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--header-bg);
            border-radius: 8px;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-text {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .tooltip {
            position: absolute;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 16px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
            max-width: 400px;
            min-width: 280px;
            display: none;
            border: 2px solid rgba(96, 165, 250, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .tooltip-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-primary);
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
            text-align: center;
        }

        .tooltip-content {
            display: grid;
            gap: 6px;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            padding: 2px 0;
        }

        .tooltip-label {
            color: var(--text-secondary);
            font-weight: 500;
            min-width: 80px;
            flex-shrink: 0;
        }

        .tooltip-value {
            color: var(--text-primary);
            font-weight: 500;
            text-align: right;
            flex-grow: 1;
        }

        .error-message {
            color: #fca5a5;
            background-color: #1e1b22;
            border: 1px solid #7f1d1d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message h3 {
            margin-top: 0;
            color: #f87171;
            font-size: 1.5em;
        }

        .error-message ul {
            text-align: left;
            max-width: 600px;
            margin: 15px auto;
        }

        .error-message code {
            background-color: #374151;
            padding: 2px 6px;
            border-radius: 4px;
            color: #d1d5db;
        }

        .batch-indicator {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 2px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 500;
            margin: 20px 0 10px 0;
            color: var(--text-primary);
            padding: 10px 0;
            border-bottom: 2px solid var(--border-color);
        }

        .view-toggle {
            display: flex;
            gap: 0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .view-toggle .toggle-btn {
            border: none;
            border-radius: 0;
            min-width: 100px;
        }

        .view-toggle .toggle-btn:not(:last-child) {
            border-right: 1px solid var(--border-color);
        }

        /* Enhanced styling for combined view spanning blocks */
        .cell[data-schedule-type="combined"] {
            overflow: visible !important;
            z-index: 1;
            position: relative;
            transition: all 0.2s ease;
        }

        .cell[data-schedule-type="combined"]:hover {
            background-color: rgba(96, 165, 250, 0.05);
        }

        .lesson-block.spanning {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .lesson-block.spanning:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        }

        /* Fix for combined view grid layout */
        .timetable[data-combined="true"] {
            position: relative;
            z-index: 1;
            overflow: visible !important;
            background-color: var(--border-color);
        }

        .timetable[data-combined="true"] .cell {
            position: relative;
            z-index: 1;
            overflow: visible !important;
            border: 1px solid rgba(75, 85, 99, 0.5);
        }

        .timetable[data-combined="true"] .lesson-block.spanning {
            z-index: 200 !important;
        }

        .timetable[data-combined="true"] .combined-lab-block {
            z-index: 300 !important;
        }

        /* Ensure non-spanning blocks don't interfere */
        .timetable[data-combined="true"] .lesson-block:not(.spanning) {
            z-index: 5;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .timetable[data-combined="true"] .lesson-block:not(.spanning):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Force visibility for combined lab blocks */
        .combined-lab-block {
            display: block !important;
            visibility: visible !important;
        }

        /* Ensure grid doesn't interfere with spanning blocks */
        .timetable[data-combined="true"] {
            contain: none !important;
        }

        /* Analytics Panel Styles */
        .analytics-container {
            margin-top: 20px;
        }

        .main-content {
            margin-top: 0;
        }

        .analytics-menu-bar {
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        .analytics-tabs {
            display: flex;
            background: var(--header-bg);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .analytics-tabs::-webkit-scrollbar {
            display: none;
        }

        .analytics-tab {
            flex: 0 0 auto;
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-tab::before {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: currentColor;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .analytics-tab.active::before {
            opacity: 1;
            background: var(--theory-color);
        }

        .analytics-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--theory-color);
            background: rgba(96, 165, 250, 0.08);
        }

        .analytics-tab:hover {
            background: rgba(96, 165, 250, 0.05);
            color: var(--text-primary);
        }

        .analytics-tab:not(.active):hover {
            border-bottom-color: rgba(96, 165, 250, 0.3);
        }

        .analytics-panels {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .analytics-panels.expanded {
            max-height: 70vh;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        /* Scroll indicator shadows */
        .analytics-panels.expanded::before {
            content: '';
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to bottom, var(--bg-secondary), transparent);
            z-index: 10;
            pointer-events: none;
        }

        .analytics-panels.expanded::after {
            content: '';
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to top, var(--bg-secondary), transparent);
            z-index: 10;
            pointer-events: none;
        }

        /* Custom Scrollbar Styling */
        .analytics-panels.expanded::-webkit-scrollbar {
            width: 8px;
        }

        .analytics-panels.expanded::-webkit-scrollbar-track {
            background: var(--cell-bg);
            border-radius: 4px;
        }

        .analytics-panels.expanded::-webkit-scrollbar-thumb {
            background: var(--theory-color);
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .analytics-panels.expanded::-webkit-scrollbar-thumb:hover {
            background: var(--theory-border);
        }

        /* Firefox scrollbar */
        .analytics-panels.expanded {
            scrollbar-width: thin;
            scrollbar-color: var(--theory-color) var(--cell-bg);
        }

        .analytics-panel {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .analytics-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .scroll-indicator {
            animation: pulse 2s infinite;
        }

        .analytics-section {
            margin-bottom: 30px;
            background: var(--cell-bg);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid var(--border-color);
            min-height: 100px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .analytics-section:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: rgba(96, 165, 250, 0.3);
        }

        .analytics-section:last-child {
            margin-bottom: 20px;
        }

        .analytics-section h4 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .analytics-section h4::before {
            content: '';
            width: 3px;
            height: 16px;
            background: var(--theory-color);
            border-radius: 2px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95em;
            flex: 1;
            font-weight: 500;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 700;
            margin-left: 10px;
            font-size: 1.05em;
        }

        .utilization-bar {
            width: 100%;
            height: 8px;
            background: var(--cell-bg);
            border-radius: 4px;
            margin: 4px 0;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .utilization-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .room-item {
            margin-bottom: 12px;
            padding: 16px;
            background: var(--cell-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .room-item:hover {
            border-color: var(--theory-color);
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.1);
            transform: translateY(-1px);
        }

        .room-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.05em;
        }

        .room-type {
            font-size: 0.65em;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--theory-color);
            color: white;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .room-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .room-stat {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .analytics-toggle-btn {
            background: var(--theory-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .analytics-toggle-btn:hover {
            background: var(--theory-border);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        .analytics-toggle-btn.expanded {
            background: var(--theory-color);
        }

        .analytics-toggle-btn .toggle-icon {
            transition: transform 0.3s ease;
        }

        .analytics-toggle-btn.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .menu-title {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.2em;
            margin: 0;
            padding: 15px 0;
            letter-spacing: -0.3px;
            text-transform: uppercase;
            font-size: 1em;
        }

        .efficiency-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .efficiency-high { background: #10b981; }
        .efficiency-medium { background: #f59e0b; }
        .efficiency-low { background: #ef4444; }

        .department-item {
            padding: 14px;
            background: var(--cell-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .department-item:hover {
            border-color: var(--theory-color);
            box-shadow: 0 2px 6px rgba(96, 165, 250, 0.1);
        }

        .department-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .teacher-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .teacher-item:hover {
            background: rgba(96, 165, 250, 0.05);
            margin: 0 -8px;
            padding-left: 8px;
            padding-right: 8px;
            border-radius: 4px;
        }

        .teacher-item:last-child {
            border-bottom: none;
        }

        .teacher-name {
            color: var(--text-primary);
            font-size: 0.95em;
            font-weight: 500;
        }

        .teacher-load {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .workload-high { color: #ef4444; }
        .workload-medium { color: #f59e0b; }
        .workload-normal { color: #10b981; }

        .chart-container {
            margin: 20px 0;
            padding: 15px;
            background: var(--cell-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .time-slot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .time-slot-item:hover {
            background: rgba(96, 165, 250, 0.05);
            margin: 0 -8px;
            padding-left: 8px;
            padding-right: 8px;
            border-radius: 4px;
        }

        .slot-time {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .slot-usage {
            color: var(--text-primary);
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: var(--cell-bg);
            padding: 20px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stats-card:hover {
            border-color: var(--theory-color);
            box-shadow: 0 6px 16px rgba(96, 165, 250, 0.15);
            transform: translateY(-2px);
        }

        .stats-card-value {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--theory-color);
            margin-bottom: 6px;
            line-height: 1;
        }

        .stats-card-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .analytics-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .analytics-tab {
                min-width: 120px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .room-item, .department-item {
                padding: 12px;
            }
            
            .analytics-panels.expanded {
                max-height: 60vh;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .analytics-panels.expanded {
                max-height: 50vh;
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }
            
            .analytics-section {
                padding: 12px;
                margin-bottom: 20px;
            }
        }

        @media (min-width: 1200px) {
            .analytics-panels.expanded {
                max-height: 75vh;
            }
        }

        @media (min-width: 1600px) {
            .analytics-panels.expanded {
                max-height: 80vh;
            }
        }

        .info-banner {
            background: linear-gradient(135deg, var(--cell-bg) 0%, var(--header-bg) 100%);
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid var(--theory-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .info-banner p {
            margin: 0;
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Advanced Timetable Visualizer - 6 Day Schedule</h1>
        <div class="info-banner">
            <p style="margin: 0; color: var(--text-secondary);">
                <strong>Six-Day Schedule Support:</strong> This visualizer supports Monday through Saturday scheduling with department-specific workday policies.
            </p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Schedule Type:</label>
                <div class="view-toggle">
                    <button class="toggle-btn active" id="theoryBtn" onclick="setScheduleType('theory')">Theory/Lectures</button>
                    <button class="toggle-btn" id="labBtn" onclick="setScheduleType('lab')">Labs</button>
                    <button class="toggle-btn" id="combinedBtn" onclick="setScheduleType('combined')">Combined</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>View:</label>
                <select id="viewType">
                    <option value="teacher">Teacher View</option>
                    <option value="group">Student Group View</option>
                </select>
            </div>
            
            <div class="control-group">
                <select id="entitySelector"></select>
            </div>

            <div class="control-group" id="teacherSearchGroup" style="display: none;">
                <label>Search Teacher:</label>
                <input type="text" id="teacherSearch" placeholder="Type teacher name..." 
                       style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; 
                              background-color: var(--cell-bg); color: var(--text-primary); font-size: 14px; 
                              min-width: 200px; transition: all 0.2s;">
            </div>

            <!-- Theme toggle button -->
            <div class="control-group" style="margin-left:auto;">
                <button id="themeToggle" class="toggle-btn">Light Mode</button>
            </div>
        </div>

        <div class="legend" id="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--theory-color); border: 1px solid var(--theory-border);"></div>
                <span class="legend-text">Theory Classes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--lecture-color); border: 1px solid var(--lecture-border);"></div>
                <span class="legend-text">Lectures</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--lab-same-color); border: 1px solid var(--lab-same-border);"></div>
                <span class="legend-text">Lab - Same Course</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--lab-different-color); border: 1px solid var(--lab-different-border);"></div>
                <span class="legend-text">Lab - Different Courses</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--lab-mixed-color); border: 1px solid var(--lab-mixed-border);"></div>
                <span class="legend-text">Lab - Mixed Batches</span>
            </div>
        </div>

        <div class="analytics-container">
            <div class="main-content">
                <div class="analytics-menu-bar">
                    <div class="menu-header">
                        <h2 class="menu-title">Analytics Dashboard</h2>
                        <button class="analytics-toggle-btn" onclick="toggleAnalytics()">
                            <span class="toggle-icon">â–¼</span>
                            <span>Show Analytics</span>
                        </button>
                    </div>
                    <div class="analytics-tabs">
                        <button class="analytics-tab active" onclick="switchAnalyticsTab('rooms')">
                            Rooms
                        </button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('departments')">
                            Departments
                        </button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('teachers')">
                            Teachers
                        </button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('timeslots')">
                            Time Slots
                        </button>
                    </div>
                    
                    <div class="analytics-panels">
                        <!-- Room Analytics Panel -->
                        <div id="rooms-panel" class="analytics-panel active">
                            <div class="analytics-section">
                                <h4>Room Utilization Overview</h4>
                                <div id="room-overview-stats"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Classroom Utilization</h4>
                                <div id="classroom-details"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Laboratory Utilization</h4>
                                <div id="lab-details"></div>
                            </div>
                        </div>

                        <!-- Department Analytics Panel -->
                        <div id="departments-panel" class="analytics-panel">
                            <div class="analytics-section">
                                <h4>Department Overview</h4>
                                <div id="department-overview-stats"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Workday Distribution</h4>
                                <div id="workday-distribution"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Course Load by Department</h4>
                                <div id="department-course-load"></div>
                            </div>
                        </div>

                        <!-- Teacher Analytics Panel -->
                        <div id="teachers-panel" class="analytics-panel">
                            <div class="analytics-section">
                                <h4>Teacher Overview</h4>
                                <div id="teacher-overview-stats"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Workload Distribution</h4>
                                <div id="teacher-workload"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Most Active Teachers</h4>
                                <div id="top-teachers"></div>
                            </div>
                        </div>

                        <!-- Time Slots Analytics Panel -->
                        <div id="timeslots-panel" class="analytics-panel">
                            <div class="analytics-section">
                                <h4>Time Slot Usage</h4>
                                <div id="timeslot-overview-stats"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Peak Hours Analysis</h4>
                                <div id="peak-hours-analysis"></div>
                            </div>
                            
                            <div class="analytics-section">
                                <h4>Daily Distribution</h4>
                                <div id="daily-distribution"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="timetableContainer">
                    <div class="timetable" id="timetable"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Theory time slots
        const THEORY_TIME_SLOTS = [
            { start: "8:00", end: "8:50" },
            { start: "9:00", end: "9:50" },
            { start: "10:00", end: "10:50" },
            { start: "11:00", end: "11:50" },
            { start: "12:00", end: "12:50" },
            { start: "13:00", end: "13:50" },
            { start: "14:00", end: "14:50" },
            { start: "15:00", end: "15:50" },
            { start: "16:00", end: "16:50" },
            { start: "17:00", end: "17:50" },
            { start: "18:00", end: "18:50" }
        ];

        // Lab time slots (2-hour slots)
        const LAB_TIME_SLOTS = [
            { start: "8:00", end: "9:40", label: "8:00-9:40" },
            { start: "9:50", end: "11:30", label: "9:50-11:30" },
            { start: "11:50", end: "13:30", label: "11:50-13:30" },
            { start: "13:50", end: "15:30", label: "13:50-15:30" },
            { start: "15:50", end: "17:30", label: "15:50-17:30" },
            { start: "17:30", end: "19:10", label: "17:30-19:10" }
        ];

        // Six-day schedule configuration (Monday through Saturday)
        // Updated to support department workday policies:
        // - Batch A departments: Monday to Friday
        // - Batch B departments: Tuesday to Saturday
        const days = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"];
        const dayDisplayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        let timetableData = null;
        let currentScheduleType = 'theory';

        // Theme handling
        let currentTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(currentTheme);

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('themeToggle').textContent = 'Dark Mode';
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('themeToggle').textContent = 'Light Mode';
            }
            localStorage.setItem('theme', theme);
            currentTheme = theme;
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        function setScheduleType(type) {
            currentScheduleType = type;
            
            // Update button states
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(type + 'Btn').classList.add('active');
            
            // Update legend visibility
            updateLegend(type);
            
            // Recreate timetable with appropriate slots
            createTimetableGrid();
            
            // Refresh display
            filterLessons();
        }

        function updateLegend(type) {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
            
            if (type === 'theory' || type === 'combined') {
                legend.innerHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--theory-color); border: 1px solid var(--theory-border);"></div>
                        <span class="legend-text">Theory Classes</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--lecture-color); border: 1px solid var(--lecture-border);"></div>
                        <span class="legend-text">Lectures</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--tutorial-color); border: 1px solid var(--tutorial-border);"></div>
                        <span class="legend-text">Tutorials</span>
                    </div>
                `;
            }
            
            if (type === 'lab' || type === 'combined') {
                legend.innerHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--lab-same-color); border: 1px solid var(--lab-same-border);"></div>
                        <span class="legend-text">Lab - Same Course</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--lab-different-color); border: 1px solid var(--lab-different-border);"></div>
                        <span class="legend-text">Lab - Different Courses</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--lab-mixed-color); border: 1px solid var(--lab-mixed-border);"></div>
                        <span class="legend-text">Lab - Mixed Batches</span>
                    </div>
                `;
            }
        }

        function createTimetableGrid() {
            console.log(`Creating timetable grid with ${days.length} days: ${dayDisplayNames.join(', ')}`);
            const timetable = document.getElementById('timetable');
            timetable.innerHTML = '';

            // For combined view, use theory time slots as base grid
            const timeSlots = currentScheduleType === 'lab' ? LAB_TIME_SLOTS : THEORY_TIME_SLOTS;
            
            // Add combined view attribute for CSS styling
            if (currentScheduleType === 'combined') {
                timetable.setAttribute('data-combined', 'true');
            } else {
                timetable.removeAttribute('data-combined');
            }

            // Create header row
            const headerRow = document.createElement('div');
            headerRow.className = 'header';
            headerRow.textContent = 'Time';
            timetable.appendChild(headerRow);

            dayDisplayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'header';
                header.textContent = day;
                timetable.appendChild(header);
            });

            // Create time slots
            timeSlots.forEach((slot, index) => {
                const timeCell = document.createElement('div');
                timeCell.className = 'time-slot';
                if (currentScheduleType === 'lab') {
                    timeCell.textContent = slot.label;
                } else {
                    timeCell.innerHTML = `${slot.start}<br>${slot.end}`;
                }
                timetable.appendChild(timeCell);

                days.forEach(day => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.day = day;
                    cell.dataset.timeSlot = index;
                    cell.dataset.scheduleType = currentScheduleType;
                    timetable.appendChild(cell);
                });
            });
        }

        function showTooltip(event, lesson) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            positionTooltip(tooltip, event.pageX + 10, event.pageY + 10);

            let tooltipContent = `
                <div class="tooltip-title">${lesson.course}</div>
                <div class="tooltip-content">
                    <div class="tooltip-row">
                        <span class="tooltip-label">Teacher:</span>
                        <span class="tooltip-value">${lesson.teacher}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Group:</span>
                        <span class="tooltip-value">${lesson.group}</span>
                    </div>
            `;

            if (lesson.batch) {
                tooltipContent += `
                    <div class="tooltip-row">
                        <span class="tooltip-label">Batch:</span>
                        <span class="tooltip-value">${lesson.batch}</span>
                    </div>
                `;
            }

            tooltipContent += `
                    <div class="tooltip-row">
                        <span class="tooltip-label">Room:</span>
                        <span class="tooltip-value">${lesson.room}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Time:</span>
                        <span class="tooltip-value">${lesson.startTime} - ${lesson.endTime}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Type:</span>
                        <span class="tooltip-value">${lesson.type}</span>
                    </div>
                </div>
            `;

            tooltip.innerHTML = tooltipContent;
        }

        function showCombinedLabTooltip(event, labLessons, startTime, endTime) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            positionTooltip(tooltip, event.pageX + 15, event.pageY + 15);

            const uniqueCourses = new Set(labLessons.map(l => l.course));
            const uniqueBatches = new Set(labLessons.map(l => l.batch).filter(b => b));

            let tooltipContent = `
                <div class="tooltip-title">ðŸ§ª Lab Session (${startTime} - ${endTime})</div>
                <div class="tooltip-content">
                    <div class="tooltip-row">
                        <span class="tooltip-label">Duration:</span>
                        <span class="tooltip-value">${getLabDuration(startTime, endTime)} hours</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Sessions:</span>
                        <span class="tooltip-value">${labLessons.length}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Type:</span>
                        <span class="tooltip-value">${uniqueCourses.size > 1 ? 'Multiple Courses' : uniqueBatches.size > 1 ? 'Multiple Batches' : 'Single Session'}</span>
                    </div>
            `;

            if (uniqueCourses.size === 1) {
                // Single course with possible multiple batches
                const lesson = labLessons[0];
                tooltipContent += `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--theory-color);">
                        <div class="tooltip-row">
                            <span class="tooltip-label">ðŸ“š Course:</span>
                            <span class="tooltip-value">${lesson.course}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">ðŸ‘¨â€ðŸ« Teacher:</span>
                            <span class="tooltip-value">${lesson.teacher}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">ðŸ¢ Room:</span>
                            <span class="tooltip-value">${lesson.room}</span>
                        </div>
                        ${uniqueBatches.size > 0 ? `
                        <div class="tooltip-row">
                            <span class="tooltip-label">ðŸ‘¥ Batches:</span>
                            <span class="tooltip-value">${Array.from(uniqueBatches).join(', ')}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Multiple courses
                labLessons.forEach((lesson, index) => {
                    const courseColor = index % 2 === 0 ? 'var(--lab-same-color)' : 'var(--lab-different-color)';
                    tooltipContent += `
                        <div style="margin-top: 10px; padding: 8px; border-left: 3px solid ${courseColor}; background: rgba(255, 255, 255, 0.05);">
                            <div class="tooltip-row">
                                <span class="tooltip-label">ðŸ“š Course:</span>
                                <span class="tooltip-value">${lesson.course}</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">ðŸ‘¨â€ðŸ« Teacher:</span>
                                <span class="tooltip-value">${lesson.teacher}</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">ðŸ¢ Room:</span>
                                <span class="tooltip-value">${lesson.room}</span>
                            </div>
                            ${lesson.batch ? `
                            <div class="tooltip-row">
                                <span class="tooltip-label">ðŸ‘¥ Batch:</span>
                                <span class="tooltip-value">${lesson.batch}</span>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            tooltipContent += `</div>`;
            tooltip.innerHTML = tooltipContent;
        }

        function getLabDuration(startTime, endTime) {
            const start = parseTime(startTime);
            const end = parseTime(endTime);
            return ((end - start) / 60).toFixed(1);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'none';
        }

        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function getSpannedTheorySlots(startTime, endTime) {
            const startMinutes = parseTime(startTime);
            const endMinutes = parseTime(endTime);
            const spannedSlots = [];
            
            for (let i = 0; i < THEORY_TIME_SLOTS.length; i++) {
                const slotStart = parseTime(THEORY_TIME_SLOTS[i].start);
                const slotEnd = parseTime(THEORY_TIME_SLOTS[i].end);
                
                // Check if lab session overlaps with this theory slot
                // Lab session overlaps if it starts before slot ends and ends after slot starts
                if (startMinutes < slotEnd && endMinutes > slotStart) {
                    spannedSlots.push(i);
                }
            }
            
            console.log(`Lab ${startTime}-${endTime} spans theory slots:`, spannedSlots, spannedSlots.map(i => THEORY_TIME_SLOTS[i]));
            return spannedSlots;
        }

        function findTimeSlotIndex(startTime, endTime, scheduleType) {
            const startMinutes = parseTime(startTime);
            const endMinutes = parseTime(endTime);

            if (scheduleType === 'lab') {
                // For lab view, choose the lab slot that overlaps the session (any overlap)
                for (let i = 0; i < LAB_TIME_SLOTS.length; i++) {
                    const slotStart = parseTime(LAB_TIME_SLOTS[i].start);
                    const slotEnd = parseTime(LAB_TIME_SLOTS[i].end);

                    // Overlap if session starts before slot end and ends after slot start
                    if (startMinutes < slotEnd && endMinutes > slotStart) {
                        return i;
                    }
                }
            } else {
                // For theory view, pick slot containing the session start time
                for (let i = 0; i < THEORY_TIME_SLOTS.length; i++) {
                    const slotStart = parseTime(THEORY_TIME_SLOTS[i].start);
                    const slotEnd = parseTime(THEORY_TIME_SLOTS[i].end);

                    if (startMinutes < slotEnd && endMinutes > slotStart) {
                        return i;
                    }
                }
            }

            return -1; // Not found
        }

        // Helper to position tooltip within viewport boundaries
        function positionTooltip(el, pageX, pageY) {
            const padding = 12; // distance from viewport edges

            const tooltipWidth = el.offsetWidth;
            const tooltipHeight = el.offsetHeight;

            let x = pageX;
            let y = pageY;

            // Horizontal overflow â†’ shift left
            const viewportRight = window.scrollX + window.innerWidth;
            if (x + tooltipWidth + padding > viewportRight) {
                x = viewportRight - tooltipWidth - padding;
            }

            // Vertical overflow â†’ show above cursor
            const viewportBottom = window.scrollY + window.innerHeight;
            if (y + tooltipHeight + padding > viewportBottom) {
                y = pageY - tooltipHeight - padding;
            }

            // Ensure not off the top
            if (y < window.scrollY + padding) {
                y = window.scrollY + padding;
            }

            // Ensure not off the left
            if (x < window.scrollX + padding) {
                x = window.scrollX + padding;
            }

            el.style.left = x + 'px';
            el.style.top = y + 'px';
        }

        function createCombinedLabBlock(labLessons, spanHeight, startTime, endTime) {
            const block = document.createElement('div');
            block.className = 'lesson-block combined-lab-block spanning';
            
            // Calculate height for spanning blocks
            if (spanHeight > 1) {
                // Calculate total height: (cell height + padding + border + gap) * span - final gap - margin
                const totalHeightPx = (80 + 8 + 2 + 1) * spanHeight - 1 - 4;
                block.style.height = `${totalHeightPx}px`;
                console.log(`Spanning block height: ${totalHeightPx}px for ${spanHeight} slots`);
            } else {
                block.style.height = '76px'; // Single cell height
            }
            
            block.style.position = 'absolute';
            block.style.width = 'calc(100% - 4px)';
            block.style.zIndex = '200';
            block.style.top = '2px';
            block.style.left = '2px';
            block.style.margin = '0';
            block.style.padding = '8px';
            block.style.boxSizing = 'border-box';
            block.style.overflow = 'hidden';
            block.style.display = 'flex';
            block.style.flexDirection = 'column';
            block.style.justifyContent = 'space-between';
            block.style.cursor = 'pointer';
            
            // Determine block color based on course diversity
            let blockType = 'lab-same';
            const uniqueCourses = new Set(labLessons.map(l => l.course));
            const uniqueBatches = new Set(labLessons.map(l => l.batch).filter(b => b));
            
            if (uniqueCourses.size > 1) {
                blockType = 'lab-different'; // Multiple different courses
            } else if (uniqueBatches.size > 1) {
                blockType = 'lab-mixed'; // Same course, different batches
            }
            
            block.classList.add(blockType);
            
            // Create content for combined lab block
            let content = `<div class="lab-time-header">${startTime} - ${endTime}</div>`;
            
            if (uniqueCourses.size === 1) {
                // Single course, multiple batches
                const course = labLessons[0].course;
                const teacher = labLessons[0].teacher;
                const room = labLessons[0].room;
                
                content += `
                    <div class="lab-course-title">${course}</div>
                    <div class="lab-teacher">${teacher}</div>
                    <div class="lab-room">${room}</div>
                `;
                
                if (uniqueBatches.size > 1) {
                    const batches = Array.from(uniqueBatches).join(', ');
                    content += `<div class="lab-batches">Batches: ${batches}</div>`;
                }
            } else {
                // Multiple courses
                content += `<div class="lab-multiple-courses">`;
                labLessons.forEach((lesson, index) => {
                    content += `
                        <div class="lab-course-item">
                            <div class="lab-course-name">${lesson.course}</div>
                            <div class="lab-course-details">${lesson.teacher} â€¢ ${lesson.room}${lesson.batch ? ` â€¢ ${lesson.batch}` : ''}</div>
                        </div>
                    `;
                    if (index < labLessons.length - 1) {
                        content += `<div class="lab-separator">|</div>`;
                    }
                });
                content += `</div>`;
            }
            
            block.innerHTML = content;
            
            // Add hover tooltip for combined block with better event handling
            block.addEventListener('mouseenter', (e) => {
                e.stopPropagation();
                showCombinedLabTooltip(e, labLessons, startTime, endTime);
            });
            block.addEventListener('mouseleave', (e) => {
                e.stopPropagation();
                hideTooltip();
            });
            block.addEventListener('mousemove', (e) => {
                e.stopPropagation();
                // Update tooltip position on mouse move
                const tooltip = document.getElementById('tooltip');
                if (tooltip.style.display === 'block') {
                    positionTooltip(tooltip, e.pageX + 15, e.pageY + 15);
                }
            });
            
            console.log(`Created combined lab block: ${uniqueCourses.size} courses, ${uniqueBatches.size} batches, spanning ${spanHeight} slots`);
            
            return block;
        }

        function createLessonBlock(lesson, spanHeight = 1) {
            const block = document.createElement('div');
            
            // Determine block type
            let blockType = 'theory';
            if (lesson.type === 'lecture') {
                blockType = 'lecture';
            } else if (lesson.type === 'tutorial') {
                blockType = 'tutorial';
            } else if (lesson.type === 'lab') {
                blockType = 'lab-same'; // Default for single lab
            }
            
            block.className = `lesson-block ${blockType}`;
            
            // If this lesson spans multiple slots, adjust height and add spanning class
            if (spanHeight > 1) {
                block.classList.add('spanning');
                // Calculate proper height for spanning blocks including gaps
                const cellHeight = 80; // min-height of cells
                const padding = 8; // cell padding (4px top + 4px bottom)
                const border = 2; // border width (1px top + 1px bottom) 
                const gap = 1; // grid gap
                const totalCellHeight = cellHeight + padding + border + gap;
                const calculatedHeight = (spanHeight * totalCellHeight) - gap - 8; // Subtract last gap and some margin
                
                block.style.height = `${calculatedHeight}px`;
                block.style.position = 'absolute';
                block.style.width = 'calc(100% - 8px)';
                block.style.zIndex = '100';
                block.style.top = '4px';
                block.style.left = '4px';
                block.style.margin = '0';
                block.style.boxSizing = 'border-box';
                
                console.log(`Creating spanning block: height=${calculatedHeight}px, spans=${spanHeight} slots`);
            }
            
            block.innerHTML = `
                <div style="font-weight: 500; margin-bottom: 2px;">${lesson.course}</div>
                <div style="font-size: 0.85em; opacity: 0.9;">${lesson.teacher}</div>
                <div style="font-size: 0.75em; opacity: 0.8;">${lesson.room}</div>
                ${lesson.batch ? `<div class="batch-indicator">Batch: ${lesson.batch}</div>` : ''}
            `;
            
            block.addEventListener('mouseenter', (e) => showTooltip(e, lesson));
            block.addEventListener('mouseleave', hideTooltip);
            
            return block;
        }

        function displayLessons(lessons) {
            // Clear existing lessons and reset cell classes
            document.querySelectorAll('.cell').forEach(cell => {
                cell.innerHTML = '';
                cell.style.position = 'relative';
                cell.classList.remove('lab-span-cell');
                cell.removeAttribute('data-occupied-by-lab');
            });

            console.log('Displaying lessons:', lessons);
            
            // Filter lessons based on schedule type
            let filteredLessons = lessons;
            if (currentScheduleType === 'theory') {
                filteredLessons = lessons.filter(lesson => 
                    lesson.type === 'lecture' || lesson.type === 'theory' || lesson.type === 'tutorial'
                );
            } else if (currentScheduleType === 'lab') {
                filteredLessons = lessons.filter(lesson => lesson.type === 'lab');
            }
            // Combined view shows all lessons
            
            if (currentScheduleType === 'combined') {
                console.log('Entering combined view mode');
                displayCombinedLessons(lessons);
            } else {
                displayStandardLessons(filteredLessons);
            }
        }

        function displayStandardLessons(lessons) {
            // Group lessons by day and time slot
            const groupedLessons = {};
            
            lessons.forEach(lesson => {
                const day = lesson.day.toUpperCase();
                const slotIndex = findTimeSlotIndex(lesson.startTime, lesson.endTime, currentScheduleType);
                
                if (slotIndex >= 0) {
                    const key = `${day}-${slotIndex}`;
                    if (!groupedLessons[key]) {
                        groupedLessons[key] = [];
                    }
                    groupedLessons[key].push(lesson);
                }
            });
            
            // Display lessons in grid
            Object.entries(groupedLessons).forEach(([key, lessonsInSlot]) => {
                const [day, timeSlotStr] = key.split('-');
                const timeSlot = parseInt(timeSlotStr);
                
                const cell = document.querySelector(`.cell[data-day="${day}"][data-time-slot="${timeSlot}"][data-schedule-type="${currentScheduleType}"]`);
                if (cell) {
                    lessonsInSlot.forEach(lesson => {
                        const block = createLessonBlock(lesson);
                        cell.appendChild(block);
                    });
                }
            });
        }

        function displayCombinedLessons(lessons) {
            console.log('Displaying combined lessons:', lessons);
            
            // Group lab sessions by day and time span
            const labGroups = new Map(); // key: "day-startTime-endTime", value: array of lessons
            const occupiedCells = new Map(); // Track which cells are occupied by labs
            
            // First, group all lab sessions by their time spans
            lessons.forEach(lesson => {
                const day = lesson.day.toUpperCase();
                
                if (lesson.type === 'lab') {
                    const timeKey = `${day}-${lesson.startTime}-${lesson.endTime}`;
                    if (!labGroups.has(timeKey)) {
                        labGroups.set(timeKey, []);
                    }
                    labGroups.get(timeKey).push(lesson);
                }
            });
            
            // Process each lab group and create spanning blocks
            labGroups.forEach((labLessons, timeKey) => {
                const [day, startTime, endTime] = timeKey.split('-');
                const spannedSlots = getSpannedTheorySlots(startTime, endTime);
                
                if (spannedSlots.length > 0) {
                    console.log(`Lab group ${timeKey} spans ${spannedSlots.length} slots:`, spannedSlots);
                    
                    // Find the first slot cell
                    const firstSlot = spannedSlots[0];
                    const firstCell = document.querySelector(`.cell[data-day="${day}"][data-time-slot="${firstSlot}"][data-schedule-type="combined"]`);
                    
                    if (firstCell) {
                        // Clear all spanned cells first and prepare them
                        spannedSlots.forEach((slotIndex, index) => {
                            const spanCell = document.querySelector(`.cell[data-day="${day}"][data-time-slot="${slotIndex}"][data-schedule-type="combined"]`);
                            if (spanCell) {
                                spanCell.innerHTML = '';
                                // Only add the pointer-events-disabling class to FOLLOWING cells
                                if (index > 0) {
                                    spanCell.classList.add('lab-span-cell');
                                }
                                spanCell.setAttribute('data-occupied-by-lab', timeKey);
                                
                                // Mark all cells as occupied
                                const key = `${day}-${slotIndex}`;
                                occupiedCells.set(key, timeKey);
                            }
                        });
                        
                        // Create and add the combined lab block to the first cell
                        const combinedBlock = createCombinedLabBlock(labLessons, spannedSlots.length, startTime, endTime);
                        firstCell.appendChild(combinedBlock);
                        
                        console.log(`Added combined lab block to cell ${day}-${firstSlot}, spanning ${spannedSlots.length} slots`);
                    } else {
                        console.error(`Could not find first cell for ${day}-${firstSlot}`);
                    }
                }
            });
            
            // Second pass: Place theory/lecture/tutorial sessions
            lessons.forEach(lesson => {
                const day = lesson.day.toUpperCase();
                
                if (lesson.type !== 'lab') {
                    const slotIndex = findTimeSlotIndex(lesson.startTime, lesson.endTime, 'theory');
                    
                    if (slotIndex >= 0) {
                        const cellKey = `${day}-${slotIndex}`;
                        const cell = document.querySelector(`.cell[data-day="${day}"][data-time-slot="${slotIndex}"][data-schedule-type="combined"]`);
                        
                        // Only place if cell is not occupied by a lab
                        if (cell && !occupiedCells.has(cellKey)) {
                            const block = createLessonBlock(lesson);
                            cell.appendChild(block);
                        }
                    }
                }
            });
        }

        function updateEntitySelector() {
            if (!timetableData) return;

            const selector = document.getElementById('entitySelector');
            const viewType = document.getElementById('viewType').value;
            const searchGroup = document.getElementById('teacherSearchGroup');
            
            selector.innerHTML = '';

            const showAllOption = document.createElement('option');
            showAllOption.value = '';
            showAllOption.textContent = 'Show All';
            selector.appendChild(showAllOption);

            if (viewType === 'teacher') {
                // Show search field for teacher view
                searchGroup.style.display = 'flex';
                
                const teachers = new Map();
                timetableData.lessons.forEach(lesson => {
                    if (!teachers.has(lesson.teacherId)) {
                        teachers.set(lesson.teacherId, lesson.teacher);
                    }
                });

                // Store all teachers for search functionality
                window.allTeachers = teachers;
                console.log('Stored teachers for search:', teachers.size, 'teachers');

                teachers.forEach((name, id) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    selector.appendChild(option);
                });
            } else {
                // Hide search field for non-teacher views
                searchGroup.style.display = 'none';
                
                const groups = new Map();
                timetableData.lessons.forEach(lesson => {
                    if (!groups.has(lesson.groupId)) {
                        groups.set(lesson.groupId, lesson.group);
                    }
                });

                groups.forEach((name, id) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    selector.appendChild(option);
                });
            }
            
            selector.value = '';
            
            // Clear search field when switching views
            const searchField = document.getElementById('teacherSearch');
            if (searchField) {
                searchField.value = '';
            }
        }

        function showErrorMessage(message) {
            const container = document.getElementById('timetableContainer');
            container.innerHTML = `
                <div class="error-message">
                    <h3>âš ï¸ Timetable Data Not Found</h3>
                    <p>${message}</p>
                    <p>Please generate your timetable first using the timetable generator, then run this visualizer.</p>
                    <ul>
                        <li>Make sure <code>timetable.json</code> exists in the same directory</li>
                        <li>Verify the JSON file contains valid timetable data</li>
                        <li>Refresh the page after generating the timetable</li>
                    </ul>
                </div>
            `;
            
            // Hide controls when no data is available
            document.querySelector('.controls').style.display = 'none';
            document.querySelector('.legend').style.display = 'none';
        }

        function filterLessons() {
            if (!timetableData) {
                showErrorMessage('No timetable data available.');
                return;
            }

            const viewType = document.getElementById('viewType').value;
            const selectedId = document.getElementById('entitySelector').value;
            
            let filteredLessons = timetableData.lessons;
            
            if (selectedId) {
                filteredLessons = timetableData.lessons.filter(lesson => {
                    if (viewType === 'teacher') {
                        return lesson.teacherId === selectedId;
                    } else {
                        return lesson.groupId === selectedId;
                    }
                });
            }

            console.log(`Filtered lessons for ${viewType} ${selectedId}:`, filteredLessons);
            displayLessons(filteredLessons);
            
            // Update analytics with filtered data
            if (selectedId) {
                const originalData = timetableData;
                timetableData = { ...originalData, lessons: filteredLessons };
                calculateAnalytics();
                timetableData = originalData; // Restore original data
            } else {
                // If showing all data, recalculate with full dataset
                calculateAnalytics();
            }
        }

        // Initialize
        createTimetableGrid();
        updateLegend('theory');

        // Load timetable data
        fetch('timetable.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to load timetable.json (HTTP ${response.status})`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Loaded timetable data:', data);
                if (!data || !data.lessons || !Array.isArray(data.lessons)) {
                    throw new Error('Invalid timetable data format');
                }
                timetableData = data;
                updateEntitySelector();
                setupTeacherSearch(); // Initialize search after data is loaded
                initializeAnalytics(); // Initialize analytics with loaded data
                filterLessons();
            })
            .catch(error => {
                console.error('Failed to load timetable data:', error.message);
                showErrorMessage(`Failed to load timetable.json: ${error.message}`);
            });

        // Teacher search functionality
        function setupTeacherSearch() {
            const searchField = document.getElementById('teacherSearch');
            const entitySelector = document.getElementById('entitySelector');
            
            if (!searchField || !entitySelector) {
                console.warn('Search elements not found, skipping search setup');
                return;
            }
            
            // Clear any existing event listeners by cloning the element
            const newSearchField = searchField.cloneNode(true);
            searchField.parentNode.replaceChild(newSearchField, searchField);
            
            // Add input event listener for real-time search
            newSearchField.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    // If search is empty, show all teachers
                    entitySelector.value = '';
                    filterLessons();
                    return;
                }
                
                // Find matching teacher
                if (window.allTeachers && window.allTeachers.size > 0) {
                    let matchedTeacherId = null;
                    let exactMatch = false;
                    
                    // Search through all teachers
                    for (const [id, name] of window.allTeachers) {
                        const teacherName = name.toLowerCase();
                        
                        // Check for exact match first
                        if (teacherName === searchTerm) {
                            matchedTeacherId = id;
                            exactMatch = true;
                            break;
                        }
                        
                        // Check for partial match if no exact match found
                        if (!exactMatch && teacherName.includes(searchTerm)) {
                            matchedTeacherId = id;
                        }
                    }
                    
                    if (matchedTeacherId) {
                        entitySelector.value = matchedTeacherId;
                        filterLessons();
                    } else {
                        // No match found, show all
                        entitySelector.value = '';
                        filterLessons();
                    }
                } else {
                    console.warn('No teachers data available for search');
                }
            });
            
            // Handle search field focus styling
            newSearchField.addEventListener('focus', function() {
                this.style.borderColor = 'var(--theory-color)';
                this.style.boxShadow = '0 0 0 2px rgba(96, 165, 250, 0.2)';
            });
            
            newSearchField.addEventListener('blur', function() {
                this.style.borderColor = 'var(--border-color)';
                this.style.boxShadow = 'none';
            });
            
            console.log('Teacher search functionality initialized');
        }

        // Event listeners
        document.getElementById('viewType').addEventListener('change', function() {
            updateEntitySelector();
            filterLessons();
        });

        document.getElementById('entitySelector').addEventListener('change', function() {
            // Update search field when manually selecting from dropdown
            const searchField = document.getElementById('teacherSearch');
            if (searchField && document.getElementById('viewType').value === 'teacher') {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.value !== '') {
                    searchField.value = selectedOption.textContent;
                } else {
                    searchField.value = '';
                }
            }
            filterLessons();
        });

        // Theme toggle listener
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // Teacher search will be initialized after data is loaded

        // ############################################################################
        // Analytics Functions
        // ############################################################################

        let analyticsData = null;
        let roomsData = null;
        let isAnalyticsVisible = false;

        // Load room data from CSV files
        async function loadRoomsData() {
            try {
                const [aBlock, bBlock, cBlock, labCore, jBlock, kBlock, techlongue] = await Promise.all([
                    fetch('data/classroom/a_block.csv').then(r => r.text()),
                    fetch('data/classroom/b_block.csv').then(r => r.text()),
                    fetch('data/classroom/c_block.csv').then(r => r.text()),
                    fetch('data/labs/lab_core.csv').then(r => r.text()),
                    fetch('data/labs/j_block.csv').then(r => r.text()),
                    fetch('data/labs/k_block.csv').then(r => r.text()),
                    fetch('data/labs/techlongue.csv').then(r => r.text())
                ]);

                const rooms = [];
                
                // Parse CSV data
                [aBlock, bBlock, cBlock, labCore, jBlock, kBlock, techlongue].forEach(csvData => {
                    const lines = csvData.split('\n').filter(line => line.trim());
                    const headers = lines[0].split(',');
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length >= headers.length) {
                            const room = {};
                            headers.forEach((header, index) => {
                                room[header.trim()] = values[index]?.trim() || '';
                            });
                            rooms.push(room);
                        }
                    }
                });

                roomsData = rooms;
                console.log('Loaded rooms data:', rooms.length, 'rooms');
                return rooms;
            } catch (error) {
                console.warn('Could not load room data:', error);
                return [];
            }
        }

        function calculateAnalytics() {
            if (!timetableData || !timetableData.lessons) return;

            const lessons = timetableData.lessons;
            const totalTheorySlots = 6 * 11; // 6 days Ã— 11 theory slots per day = 66 slots
            const totalLabSlots = 6 * 6; // 6 days Ã— 6 lab slots per day = 36 slots

            // Room utilization analytics
            const roomUsage = new Map();
            const roomTypes = new Map();
            
            lessons.forEach(lesson => {
                if (lesson.room) {
                    if (!roomUsage.has(lesson.room)) {
                        roomUsage.set(lesson.room, { theory: 0, lab: 0, total: 0 });
                    }
                    
                    const usage = roomUsage.get(lesson.room);
                    if (lesson.type === 'lab') {
                        usage.lab++;
                    } else {
                        usage.theory++;
                    }
                    usage.total++;
                    
                    // Determine room type from lesson type or room name
                    if (!roomTypes.has(lesson.room)) {
                        const isLab = lesson.type === 'lab' || 
                                     lesson.room.toLowerCase().includes('lab') ||
                                     lesson.room.toLowerCase().includes('workshop');
                        roomTypes.set(lesson.room, isLab ? 'lab' : 'classroom');
                    }
                }
            });

            // Department analytics
            const departmentData = new Map();
            const teacherData = new Map();
            const timeSlotData = new Map();
            const dailyData = new Map();

            lessons.forEach(lesson => {
                // Department analytics
                const dept = lesson.group?.split(' ')[0] || 'Unknown';
                if (!departmentData.has(dept)) {
                    departmentData.set(dept, { lessons: 0, courses: new Set(), teachers: new Set() });
                }
                const deptInfo = departmentData.get(dept);
                deptInfo.lessons++;
                deptInfo.courses.add(lesson.course);
                deptInfo.teachers.add(lesson.teacher);

                // Teacher analytics
                if (!teacherData.has(lesson.teacher)) {
                    teacherData.set(lesson.teacher, { lessons: 0, hours: 0, departments: new Set(), courses: new Set() });
                }
                const teacherInfo = teacherData.get(lesson.teacher);
                teacherInfo.lessons++;
                teacherInfo.hours += lesson.type === 'lab' ? 2 : 1;
                teacherInfo.departments.add(dept);
                teacherInfo.courses.add(lesson.course);

                // Time slot analytics
                const timeKey = `${lesson.startTime}-${lesson.endTime}`;
                if (!timeSlotData.has(timeKey)) {
                    timeSlotData.set(timeKey, { count: 0, type: lesson.type === 'lab' ? 'lab' : 'theory' });
                }
                timeSlotData.get(timeKey).count++;

                // Daily analytics
                if (!dailyData.has(lesson.day)) {
                    dailyData.set(lesson.day, { lessons: 0, rooms: new Set(), teachers: new Set() });
                }
                const dayInfo = dailyData.get(lesson.day);
                dayInfo.lessons++;
                dayInfo.rooms.add(lesson.room);
                dayInfo.teachers.add(lesson.teacher);
            });

            analyticsData = {
                rooms: { usage: roomUsage, types: roomTypes, totalTheorySlots, totalLabSlots },
                departments: departmentData,
                teachers: teacherData,
                timeSlots: timeSlotData,
                daily: dailyData,
                totalLessons: lessons.length
            };

            updateAnalyticsDisplay();
        }

        function updateAnalyticsDisplay() {
            if (!analyticsData) return;

            updateRoomAnalytics();
            updateDepartmentAnalytics();
            updateTeacherAnalytics();
            updateTimeSlotAnalytics();
        }

        function updateRoomAnalytics() {
            const { usage, types, totalTheorySlots, totalLabSlots } = analyticsData.rooms;
            
            // Overview stats
            const overviewStats = document.getElementById('room-overview-stats');
            const totalRooms = usage.size;
            const classrooms = Array.from(types.entries()).filter(([_, type]) => type === 'classroom').length;
            const labs = Array.from(types.entries()).filter(([_, type]) => type === 'lab').length;
            
            let totalUtilization = 0;
            usage.forEach((roomUsage, roomName) => {
                const roomType = types.get(roomName);
                const maxSlots = roomType === 'lab' ? totalLabSlots : totalTheorySlots;
                totalUtilization += (roomUsage.total / maxSlots) * 100;
            });
            const avgUtilization = totalRooms > 0 ? (totalUtilization / totalRooms).toFixed(1) : 0;

            overviewStats.innerHTML = `
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-card-value">${totalRooms}</div>
                        <div class="stats-card-label">Total Rooms</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${classrooms}</div>
                        <div class="stats-card-label">Classrooms</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${labs}</div>
                        <div class="stats-card-label">Laboratories</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${avgUtilization}%</div>
                        <div class="stats-card-label">Avg Utilization</div>
                    </div>
                 </div>
            `;

            // Classroom details
            const classroomDetails = document.getElementById('classroom-details');
            const classroomUsage = Array.from(usage.entries())
                .filter(([roomName, _]) => types.get(roomName) === 'classroom')
                .sort((a, b) => b[1].total - a[1].total);

            classroomDetails.innerHTML = classroomUsage.map(([roomName, roomUsage]) => {
                const utilization = ((roomUsage.total / totalTheorySlots) * 100).toFixed(1);
                const efficiency = utilization > 70 ? 'high' : utilization > 40 ? 'medium' : 'low';
                
                return `
                    <div class="room-item">
                        <div class="room-name">
                            ${roomName}
                            <span class="room-type">Classroom</span>
                        </div>
                        <div class="utilization-bar">
                            <div class="utilization-fill" style="width: ${utilization}%"></div>
                        </div>
                        <div class="room-stats">
                            <div class="room-stat">Usage: ${roomUsage.total}/${totalTheorySlots}</div>
                            <div class="room-stat">Utilization: ${utilization}%</div>
                        </div>
                        <span class="efficiency-indicator efficiency-${efficiency}"></span>
                    </div>
                `;
            }).join('');

            // Lab details
            const labDetails = document.getElementById('lab-details');
            const labUsage = Array.from(usage.entries())
                .filter(([roomName, _]) => types.get(roomName) === 'lab')
                .sort((a, b) => b[1].total - a[1].total);

            labDetails.innerHTML = labUsage.map(([roomName, roomUsage]) => {
                const utilization = ((roomUsage.total / totalLabSlots) * 100).toFixed(1);
                const efficiency = utilization > 60 ? 'high' : utilization > 30 ? 'medium' : 'low';
                
                return `
                    <div class="room-item">
                        <div class="room-name">
                            ${roomName}
                            <span class="room-type" style="background: var(--lab-same-color)">Laboratory</span>
                        </div>
                        <div class="utilization-bar">
                            <div class="utilization-fill" style="width: ${utilization}%"></div>
                        </div>
                        <div class="room-stats">
                            <div class="room-stat">Usage: ${roomUsage.total}/${totalLabSlots}</div>
                            <div class="room-stat">Utilization: ${utilization}%</div>
                        </div>
                        <span class="efficiency-indicator efficiency-${efficiency}"></span>
                    </div>
                `;
            }).join('');
        }

        function updateDepartmentAnalytics() {
            const departments = analyticsData.departments;
            
            // Department overview
            const overviewStats = document.getElementById('department-overview-stats');
            const deptArray = Array.from(departments.entries()).sort((a, b) => b[1].lessons - a[1].lessons);
            
            overviewStats.innerHTML = `
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-card-value">${departments.size}</div>
                        <div class="stats-card-label">Total Departments</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${analyticsData.totalLessons}</div>
                        <div class="stats-card-label">Total Lessons</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${deptArray[0]?.[0] || 'N/A'}</div>
                        <div class="stats-card-label">Most Active Dept</div>
                    </div>
                 </div>
            `;

            // Workday distribution
            const workdayDist = document.getElementById('workday-distribution');
            const mondayFriday = ['AERO', 'AUTO', 'MECH', 'MCT', 'CIVIL', 'CHEM', 'EEE', 'ECE'];
            const tuesdaySaturday = ['BME', 'BT', 'FT', 'AIDS', 'CSBS', 'CSE', 'CSD', 'AIML', 'IT'];
            
            let monFriCount = 0, tuesSatCount = 0, otherCount = 0;
            deptArray.forEach(([deptName, _]) => {
                if (mondayFriday.includes(deptName)) monFriCount++;
                else if (tuesdaySaturday.includes(deptName)) tuesSatCount++;
                else otherCount++;
            });

            workdayDist.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Monday-Friday Departments</span>
                    <span class="stat-value">${monFriCount}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tuesday-Saturday Departments</span>
                    <span class="stat-value">${tuesSatCount}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Other Departments</span>
                    <span class="stat-value">${otherCount}</span>
                </div>
            `;

            // Course load by department
            const courseLoad = document.getElementById('department-course-load');
            courseLoad.innerHTML = deptArray.slice(0, 10).map(([deptName, deptData]) => `
                <div class="department-item">
                    <div class="department-name">${deptName}</div>
                    <div class="stat-item">
                        <span class="stat-label">Lessons</span>
                        <span class="stat-value">${deptData.lessons}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Courses</span>
                        <span class="stat-value">${deptData.courses.size}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Teachers</span>
                        <span class="stat-value">${deptData.teachers.size}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateTeacherAnalytics() {
            const teachers = analyticsData.teachers;
            const teacherArray = Array.from(teachers.entries()).sort((a, b) => b[1].hours - a[1].hours);
            
            // Teacher overview
            const overviewStats = document.getElementById('teacher-overview-stats');
            const totalTeachers = teachers.size;
            const avgHours = totalTeachers > 0 ? (teacherArray.reduce((sum, [_, data]) => sum + data.hours, 0) / totalTeachers).toFixed(1) : 0;
            const maxHours = teacherArray[0]?.[1]?.hours || 0;
            
            overviewStats.innerHTML = `
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-card-value">${totalTeachers}</div>
                        <div class="stats-card-label">Total Teachers</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${avgHours}</div>
                        <div class="stats-card-label">Average Hours</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${maxHours}</div>
                        <div class="stats-card-label">Maximum Hours</div>
                    </div>
                 </div>
            `;

            // Workload distribution
            const workloadDist = document.getElementById('teacher-workload');
            let lightLoad = 0, normalLoad = 0, heavyLoad = 0;
            teacherArray.forEach(([_, data]) => {
                if (data.hours <= 8) lightLoad++;
                else if (data.hours <= 16) normalLoad++;
                else heavyLoad++;
            });

            workloadDist.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Light Load (â‰¤8h)</span>
                    <span class="stat-value workload-normal">${lightLoad}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Normal Load (9-16h)</span>
                    <span class="stat-value workload-medium">${normalLoad}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Heavy Load (>16h)</span>
                    <span class="stat-value workload-high">${heavyLoad}</span>
                </div>
            `;

            // Top teachers
            const topTeachers = document.getElementById('top-teachers');
            topTeachers.innerHTML = teacherArray.slice(0, 10).map(([teacherName, data]) => {
                const workloadClass = data.hours <= 8 ? 'workload-normal' : data.hours <= 16 ? 'workload-medium' : 'workload-high';
                return `
                    <div class="teacher-item">
                        <div class="teacher-name">${teacherName}</div>
                        <div class="teacher-load ${workloadClass}">${data.hours}h (${data.lessons} lessons)</div>
                    </div>
                `;
            }).join('');
        }

        function updateTimeSlotAnalytics() {
            const timeSlots = analyticsData.timeSlots;
            const daily = analyticsData.daily;
            
            // Time slot overview
            const overviewStats = document.getElementById('timeslot-overview-stats');
            const slotArray = Array.from(timeSlots.entries()).sort((a, b) => b[1].count - a[1].count);
            const totalSlots = slotArray.length;
            const mostUsed = slotArray[0];
            const leastUsed = slotArray[slotArray.length - 1];
            
            overviewStats.innerHTML = `
                <div class="stats-grid">
                    <div class="stats-card">
                        <div class="stats-card-value">${totalSlots}</div>
                        <div class="stats-card-label">Active Time Slots</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${mostUsed?.[1]?.count || 0}</div>
                        <div class="stats-card-label">Peak Usage</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-card-value">${mostUsed?.[0] || 'N/A'}</div>
                        <div class="stats-card-label">Most Used Slot</div>
                    </div>
                 </div>
            `;

            // Peak hours analysis
            const peakHours = document.getElementById('peak-hours-analysis');
            peakHours.innerHTML = slotArray.slice(0, 8).map(([timeSlot, data]) => `
                <div class="time-slot-item">
                    <span class="slot-time">${timeSlot}</span>
                    <span class="slot-usage">${data.count} lessons</span>
                </div>
            `).join('');

            // Daily distribution
            const dailyDist = document.getElementById('daily-distribution');
            const dayOrder = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
            dailyDist.innerHTML = dayOrder.map(day => {
                const dayData = daily.get(day) || { lessons: 0, rooms: new Set(), teachers: new Set() };
                return `
                    <div class="stat-item">
                        <span class="stat-label">${day.charAt(0) + day.slice(1).toLowerCase()}</span>
                        <span class="stat-value">${dayData.lessons} lessons</span>
                    </div>
                `;
            }).join('');
        }

        function switchAnalyticsTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.analytics-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.analytics-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tabName}-panel`).classList.add('active');
        }

        function toggleAnalytics() {
            const panels = document.querySelector('.analytics-panels');
            const button = document.querySelector('.analytics-toggle-btn');
            const toggleIcon = button.querySelector('.toggle-icon');
            const toggleText = button.querySelector('span:last-child');
            
            isAnalyticsVisible = !isAnalyticsVisible;
            
            if (isAnalyticsVisible) {
                panels.classList.add('expanded');
                button.classList.add('expanded');
                toggleIcon.textContent = 'â–²';
                toggleText.textContent = 'Hide Analytics';
                
                // Check if content is scrollable and add indicator
                setTimeout(() => {
                    checkScrollableContent();
                }, 350); // Wait for animation to complete
            } else {
                panels.classList.remove('expanded');
                button.classList.remove('expanded');
                toggleIcon.textContent = 'â–¼';
                toggleText.textContent = 'Show Analytics';
                
                // Remove scroll indicator when collapsed
                const indicator = button.querySelector('.scroll-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }

        // Initialize analytics when data is loaded
        function initializeAnalytics() {
            if (timetableData && timetableData.lessons) {
                calculateAnalytics();
                loadRoomsData();
            }
        }

        function checkScrollableContent() {
            const panels = document.querySelector('.analytics-panels');
            const button = document.querySelector('.analytics-toggle-btn');
            
            if (panels && panels.scrollHeight > panels.clientHeight) {
                // Content is scrollable, add indicator
                if (!button.querySelector('.scroll-indicator')) {
                    const scrollIndicator = document.createElement('span');
                    scrollIndicator.className = 'scroll-indicator';
                    scrollIndicator.textContent = 'â†•';
                    scrollIndicator.style.cssText = `
                        color: rgba(255,255,255,0.7);
                        font-size: 0.8em;
                        margin-left: 4px;
                        opacity: 0.8;
                    `;
                    button.appendChild(scrollIndicator);
                }
            } else {
                // Remove indicator if content is not scrollable
                const indicator = button.querySelector('.scroll-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }
    </script>
</body>
</html>